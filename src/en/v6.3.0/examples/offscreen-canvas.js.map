{"version":3,"sources":["webpack:///../node_modules/json-stringify-safe/stringify.js","webpack:///./offscreen-canvas.worker.js","webpack:///./offscreen-canvas.js"],"names":["serializer","replacer","cycleReplacer","stack","keys","key","value","slice","indexOf","join","length","thisPos","this","splice","push","Infinity","call","module","exports","obj","spaces","JSON","stringify","getSerialize","Worker","container","transformContainer","canvas","rendering","workerFrameState","mainThreadFrameState","worker","updateContainerTransform","const","viewState","renderedViewState","center","resolution","rotation","renderedCenter","renderedResolution","renderedRotation","transform","style","map","layers","render","frameState","document","createElement","position","width","height","appendChild","left","transformOrigin","animate","postMessage","action","parse","source","attributions","target","view","resolutions","tileSize","getResolutions89","zoom","addControl","addEventListener","message","data","image","Image","crossOrigin","createImageBitmap","then","imageBitmap","src","event","requestAnimationFrame","imageData","getContext","drawImage"],"mappings":"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","file":"offscreen-canvas.js","sourcesContent":["exports = module.exports = stringify\nexports.getSerialize = serializer\n\nfunction stringify(obj, replacer, spaces, cycleReplacer) {\n  return JSON.stringify(obj, serializer(replacer, cycleReplacer), spaces)\n}\n\nfunction serializer(replacer, cycleReplacer) {\n  var stack = [], keys = []\n\n  if (cycleReplacer == null) cycleReplacer = function(key, value) {\n    if (stack[0] === value) return \"[Circular ~]\"\n    return \"[Circular ~.\" + keys.slice(0, stack.indexOf(value)).join(\".\") + \"]\"\n  }\n\n  return function(key, value) {\n    if (stack.length > 0) {\n      var thisPos = stack.indexOf(this)\n      ~thisPos ? stack.splice(thisPos + 1) : stack.push(this)\n      ~thisPos ? keys.splice(thisPos, Infinity, key) : keys.push(key)\n      if (~stack.indexOf(value)) value = cycleReplacer.call(this, key, value)\n    }\n    else stack.push(value)\n\n    return replacer == null ? value : replacer.call(this, key, value)\n  }\n}\n","module.exports = function() {\n  return new Worker(__webpack_public_path__ + \"727a93d124255fd9e580.worker.js\");\n};","import Map from '../src/ol/Map.js';\nimport View from '../src/ol/View.js';\nimport Layer from '../src/ol/layer/Layer.js';\nimport Worker from 'worker-loader!./offscreen-canvas.worker.js'; //eslint-disable-line\nimport {compose, create} from '../src/ol/transform.js';\nimport {createTransformString} from '../src/ol/render/canvas.js';\nimport {createXYZ} from '../src/ol/tilegrid.js';\nimport {FullScreen} from '../src/ol/control.js';\nimport stringify from 'json-stringify-safe';\nimport Source from '../src/ol/source/Source.js';\n\nconst worker = new Worker();\n\nlet container, transformContainer, canvas, rendering, workerFrameState, mainThreadFrameState;\n\n// Transform the container to account for the differnece between the (newer)\n// main thread frameState and the (older) worker frameState\nfunction updateContainerTransform() {\n  if (workerFrameState) {\n    const viewState = mainThreadFrameState.viewState;\n    const renderedViewState = workerFrameState.viewState;\n    const center = viewState.center;\n    const resolution = viewState.resolution;\n    const rotation = viewState.rotation;\n    const renderedCenter = renderedViewState.center;\n    const renderedResolution = renderedViewState.resolution;\n    const renderedRotation = renderedViewState.rotation;\n    const transform = create();\n    // Skip the extra transform for rotated views, because it will not work\n    // correctly in that case\n    if (!rotation) {\n      compose(transform,\n        (renderedCenter[0] - center[0]) / resolution,\n        (center[1] - renderedCenter[1]) / resolution,\n        renderedResolution / resolution, renderedResolution / resolution,\n        rotation - renderedRotation,\n        0, 0);\n    }\n    transformContainer.style.transform = createTransformString(transform);\n  }\n}\n\nconst map = new Map({\n  layers: [\n    new Layer({\n      render: function(frameState) {\n        if (!container) {\n          container = document.createElement('div');\n          container.style.position = 'absolute';\n          container.style.width = '100%';\n          container.style.height = '100%';\n          transformContainer = document.createElement('div');\n          transformContainer.style.position = 'absolute';\n          transformContainer.style.width = '100%';\n          transformContainer.style.height = '100%';\n          container.appendChild(transformContainer);\n          canvas = document.createElement('canvas');\n          canvas.style.position = 'absolute';\n          canvas.style.left = '0';\n          canvas.style.transformOrigin = 'top left';\n          transformContainer.appendChild(canvas);\n        }\n        mainThreadFrameState = frameState;\n        updateContainerTransform();\n        if (!rendering) {\n          rendering = true;\n          worker.postMessage({\n            action: 'render',\n            frameState: JSON.parse(stringify(frameState))\n          });\n        } else {\n          frameState.animate = true;\n        }\n        return container;\n      },\n      source: new Source({\n        attributions: [\n          '<a href=\"https://www.maptiler.com/copyright/\" target=\"_blank\">© MapTiler</a>',\n          '<a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">© OpenStreetMap contributors</a>'\n        ]\n      })\n    })\n  ],\n  target: 'map',\n  view: new View({\n    resolutions: createXYZ({tileSize: 512}).getResolutions89,\n    center: [0, 0],\n    zoom: 2\n  })\n});\nmap.addControl(new FullScreen());\n\n// Worker messaging and actions\nworker.addEventListener('message', message => {\n  if (message.data.action === 'loadImage') {\n    // Image loader for ol-mapbox-style\n    const image = new Image();\n    image.crossOrigin = 'anonymous';\n    image.addEventListener('load', function() {\n      createImageBitmap(image, 0, 0, image.width, image.height).then(imageBitmap => {\n        worker.postMessage({\n          action: 'imageLoaded',\n          image: imageBitmap,\n          src: message.data.src\n        }, [imageBitmap]);\n      });\n    });\n    image.src = event.data.src;\n  } else if (message.data.action === 'requestRender') {\n    // Worker requested a new render frame\n    map.render();\n  } else if (canvas && message.data.action === 'rendered') {\n    // Worker provies a new render frame\n    requestAnimationFrame(function() {\n      const imageData = message.data.imageData;\n      canvas.width = imageData.width;\n      canvas.height = imageData.height;\n      canvas.getContext('2d').drawImage(imageData, 0, 0);\n      canvas.style.transform = message.data.transform;\n      workerFrameState = message.data.frameState;\n      updateContainerTransform();\n    });\n    rendering = false;\n  }\n});\n"],"sourceRoot":""}